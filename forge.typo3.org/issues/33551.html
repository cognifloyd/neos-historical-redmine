<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<!-- Mirrored from forge.typo3.org/issues/33551 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 21:59:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Bug #33551: View helper values break out of a partial scope - TYPO3.Fluid - TYPO3 Forge</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<link href="../themes/TYPO3/stylesheets/applicationfaba.css?1437165176" media="all" rel="stylesheet" type="text/css" />
<script src="../javascripts/prototypefaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/effectsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/dragdropfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/controlsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/applicationfaba.js?1437165176" type="text/javascript"></script>
<script src="../plugin_assets/flow_design_helpers/javascripts/custom-scriptsf881.js?1437165331" type="text/javascript"></script>

<!--[if IE]>
    <style type="text/css">
      * html body{ width: expression( document.documentElement.clientWidth < 900 ? '900px' : '100%' ); }
      body {behavior: url(/stylesheets/csshover.htc?1437165176);}
    </style>
<![endif]-->
 <link href="../plugin_assets/redmine_backlogs/stylesheets/jquery/jquery.jqplot.minb674.css?1437165332" media="screen" rel="stylesheet" type="text/css" />

<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-1.6.2.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-ui-1.8.16.custom.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jeditable.minib674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.scrollfollowb674.js?1437165332" type="text/javascript"></script>

<!--[if IE]>
<script src="/plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/excanvas.js?1437165332" type="text/javascript"></script>
<![endif]-->
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/jquery.jqplotb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.highlighterb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasTextRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasAxisTickRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.enhancedLegendRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.cookieb674.js?1437165332" type="text/javascript"></script>

<script type="text/javascript"
        src="../rb/server_variables.js">
</script>
<script src="../plugin_assets/redmine_backlogs/javascripts/commonb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/burndownb674.js?1437165332" type="text/javascript"></script>


<style type="text/css">

#header #right-area, #header #right-area h1, #header #right-area a {
  color:#FFFFFF;
}

</style>

<!-- page specific tags -->

    <link href="../../external.html?link=https://forge.typo3.org/issues/33551.atom" rel="alternate" title="TYPO3.Fluid - Bug #33551: View helper values break out of a partial scope" type="application/atom+xml" />
    <link href="../themes/TYPO3/stylesheets/scmfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" />
<script src="../javascripts/context_menufaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/context_menufaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /><script src="../javascripts/jstoolbar/jstoolbarfaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/textilefaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/lang/jstoolbar-enfaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/jstoolbarfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /></head>
<body>
<div id="wrapper">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/login" class="login">Sign in</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/account/register" class="register">Register</a></li></ul>    </div>
    
    <ul><li><a href="../../external.html?link=https://forge.typo3.org/" class="home">Home</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects" class="projects">Projects</a></li>
<li><a href="../../external.html?link=http://www.redmine.org/guide" class="help">Help</a></li></ul></div>
      
<div id="header">
    <div id="header-left">
        <div id="header-menu">
            <a href="../../external.html?link=https://forge.typo3.org/" class="start">Start</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms" class="level-0 sorting-10">TYPO3 CMS</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3neos" class="level-0 sorting-20">TYPO3 Neos</a><a href="../../external.html?link=https://forge.typo3.org/projects/flow3" class="level-0 current sorting-20">TYPO3 Flow</a><a href="../../external.html?link=https://forge.typo3.org/projects/team-docteam" class="level-0 sorting-26">Documentation</a><a href="../../external.html?link=https://forge.typo3.org/projects/other" class="level-0 sorting-30">other</a>
        </div>
    </div>
    
    <div id="right-area"  style="background-color:#FFFFFF;background-image:url(../headerimages/517.jpg);">
        <div id="quick-search">
            <form action="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/search" method="get">
            <input name="issues" type="hidden" value="1" />
            <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/search" accesskey="4" style="color:#FFFFFF">Search</a>:
            <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
            </form>
        </div>

        <h1>TYPO3.Fluid</h1>
        <div id="quicklinks"><p>Wiki of the <a href="../../external.html?link=http://forge.typo3.org/projects/typo3v4-mvc/wiki" class="external">Extbase Project</a></p></div>
    </div>
    
    <div id="main-menu">
        <input class="projectsearch placeholder" id="projectname_project" name="projectname[project]" onfocus="this.value = &quot;&quot;; $(this).removeClassName(&quot;placeholder&quot;);" size="30" type="text" value="Project title search" /><div class="auto_complete" id="projectname_project_auto_complete"></div><script type="text/javascript">
//<![CDATA[
var projectname_project_auto_completer = new Ajax.Autocompleter('projectname_project', 'projectname_project_auto_complete', '/projects/auto_complete', {afterUpdateElement:function(element, value) { var identNode = $(value).select(".identifier"); window.location.href="/projects/"+identNode[0].innerHTML }})
//]]>
</script>
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid" class="overview">Overview</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity" class="activity">Activity</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues" class="issues selected">Issues</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div class="" id="main">
    <div id="leftmenu">
        <a href="../../external.html?link=https://forge.typo3.org/projects/flow3-distribution-base" class="level-1 current sorting-0">TYPO3 Flow Base Distribution</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-eel" class="level-2 sorting-0">TYPO3.Eel</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow" class="level-2 sorting-0">TYPO3.Flow</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid" class="level-2 current sorting-0">TYPO3.Fluid</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-kickstart" class="level-2 sorting-0">TYPO3.Kickstart</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-welcome" class="level-2 sorting-0">TYPO3.Welcome</a><a href="../../external.html?link=https://forge.typo3.org/projects/packages" class="level-1 sorting-10">Packages</a><a href="../../external.html?link=https://forge.typo3.org/projects/flow3-apps" class="level-1 sorting-30">Applications</a>
    </div>
    <div id="sidebar">        
        
  <h3>Issues</h3>
<a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?set_filter=1">View all issues</a><br />

<a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues/report">Summary</a><br />







<h3>Custom queries</h3><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=195" class="query">1.0 beta 1</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=133" class="query">Hierarchical Issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=322" class="query">Most wanted Bugfixes</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=321" class="query">Most wanted Features</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=167" class="query">My open issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=203" class="query">New &amp; Unassigned</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=90" class="query">Open Bugs</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/issues?query_id=204" class="query">Recently modified</a>



  

        
    </div>
    
    <div id="content">
				
        <div class="contextual">


<span class="issue-33551-watcher"></span>


</div>


<h2>Bug #33551</h2>

<div class="issue status-1 priority-1 details">
  

  

<div class="subject">
<div><h3>View helper values break out of a partial scope</h3></div>
</div>
        <p class="author">
        Added by <a href="../../external.html?link=https://forge.typo3.org/users/1834">Stephan Schuler</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2012-01-31" title="2012-01-31 12:05">over 3 years</a> ago.
        
        Updated <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-06-05" title="2013-06-05 14:41">about 2 years</a> ago.
        
        </p>

<table class="attributes">
<tr>
    <th class="status">Status:</th><td class="status">New</td>
    <th class="start-date">Start date:</th><td class="start-date">2012-01-31</td>
</tr>
<tr>
    <th class="priority">Priority:</th><td class="priority">Must have</td>
    <th class="due-date">Due date:</th><td class="due-date"></td>
</tr>
<tr>
    <th class="assigned-to">Assigned To:</th><td class="assigned-to"><a href="../../external.html?link=https://forge.typo3.org/users/11">Sebastian Kurfuerst</a></td>
    <th class="progress">% Done:</th><td class="progress"><table class="progress" style="width: 80px;"><tr><td class="todo" style="width: 100%;"></td></tr></table><p class="pourcent">0%</p></td>
</tr>
<tr>
    <th class="category">Category:</th><td class="category">Core</td>
    
    <th></th>
    <td></td>
    
</tr>
<tr>
    <th class="fixed-version">Target version:</th><td class="fixed-version">-</td>
    
</tr>
<tr>
	<th>Has patch:</th><td>No</td>
	<th>Affected Flow version:</th><td>(any)</td>
</tr>


</table>

<hr />

  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>If a partial is called at least twice which has a certain view helper inside, the last occurence of the inside value breaks out of the partials scope and will be the result of all usages of this view helper from now on.</p>


	<p>This only appears when the first call triggers the caching mechanism but executes the uncached template (AbstractTemplateView::render() $parsedTemplate is instance of "TYPO3\Fluid\Core\Parser\ParsingState").<br />As soon as the template is a compiled one (AbstractTemplateView::render() $parsedTemplate is instance of "TYPO3\Fluid\Core\Compiler\AbstractCompiledTemplate"), the result is as expected.</p>


	<p>Main template:<br /><pre>
&lt;html&gt;
    &lt;head&gt;
        &lt;title&gt;Little bug&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
        &lt;ol&gt;
            &lt;li&gt;&lt;f:escape type="xml"&gt;I am pre partial&lt;/f:escape&gt;&lt;/li&gt;
            &lt;f:render partial="Demo" arguments="{value: 'I am the first node within a partial'}" /&gt;
            &lt;f:render partial="Demo" arguments="{value: 'I am not the first but the second node within a partial'}" /&gt;
            &lt;li&gt;&lt;f:escape type="xml"&gt;I am post partial&lt;/f:escape&gt;&lt;/li&gt;
        &lt;/ol&gt;
    &lt;/body&gt;
&lt;/html&gt;
</pre></p>


	<p>Demo-Partial:<br /><pre>
&lt;li&gt;&lt;f:escape type="xml"&gt;{value}&lt;/f:escape&gt;&lt;/li&gt;
</pre></p>


	<p>The expected result would be:<br /><pre>
1. I am pre partial
2. I am the first node within a partial
3. I am not the first but the second node within a partial
4. I am post partial
</pre></p>


	<p>But the given result is:<br /><pre>
1. I am pre partial
2. I am the first node within a partial
3. I am not the first but the second node within a partial
4. I am not the first but the second node within a partial
</pre></p>
  </div>








<hr />
<div id="relations">
<div class="contextual">

</div>

<p><strong>Related issues</strong></p>


<form>
<table class="list issues">

<tr class="issue hascontextmenu" id="relation-8532">
<td class="checkbox"><input name="ids[]" type="checkbox" value="47674" /></td>
<td class="subject">related to 
    TYPO3.Fluid - 
    <a href="47674.html" class="issue status-7 priority-2 closed">Bug #47674</a>: HtmlentitiesViewHelper is scope singleton
</td>
<td class="status">Resolved</td>
<td class="start_date">2013-04-28</td>
<td class="due_date"></td>
<td class="buttons"></td>
</tr>

</table>
</form>


<form action="../../external.html?link=https://forge.typo3.org/issues/33551/relations" id="new-relation-form" method="post" onsubmit="new Ajax.Request('/issues/33551/relations', {asynchronous:true, evalScripts:true, method:'post', onComplete:function(request){Form.Element.focus('relation_issue_to_id');}, parameters:Form.serialize(this)}); return false;" style="display: none;"><div style="margin:0;padding:0;display:inline"><input name="authenticity_token" type="hidden" value="IjgAk+sryuS7AAkPn7/ITUV652f6cwFBHN6GNTvW7o8=" /></div>


<p><select id="relation_relation_type" name="relation[relation_type]" onchange="setPredecessorFieldsVisibility();"><option value="relates">related to</option>
<option value="duplicates">duplicates</option>
<option value="duplicated">duplicated by</option>
<option value="blocks">blocks</option>
<option value="blocked">blocked by</option>
<option value="precedes">precedes</option>
<option value="follows">follows</option></select>
Issue #<input id="relation_issue_to_id" name="relation[issue_to_id]" size="10" type="text" />
<span id="predecessor_fields" style="display:none;">
Delay: <input id="relation_delay" name="relation[delay]" size="3" type="text" /> days
</span>
<input name="commit" type="submit" value="Add" />
<a href="#" onclick="Element.toggle('new-relation-form'); this.blur(); return false;">Cancel</a>
</p>

<div id="related_issue_candidates" class="autocomplete"></div>
<script type="text/javascript">
//<![CDATA[
observeRelatedIssueField('/issues/auto_complete?id=33551&amp;project_id=package-typo3-fluid')
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>

</div>


</div>




<div id="history">
<h3>History</h3>

  <div id="change-106072" class="journal has-notes has-details">
    <h4><a href="33551.html#note-1" class="journal-link">#1</a>
    
    <a name="note-1"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2012-03-08" title="2012-03-08 20:52">over 3 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Category</strong> set to <i>Core</i></li>
      
       <li><strong>Status</strong> changed from <i>New</i> to <i>Accepted</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-106072-notes"><p>Wow, thanks for the detailed description</p></div>
  </div>
  

  <div id="change-106074" class="journal has-notes has-details">
    <h4><a href="33551.html#note-2" class="journal-link">#2</a>
    
    <a name="note-2"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2012-03-08" title="2012-03-08 21:23">over 3 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>Accepted</i> to <i>Needs Feedback</i></li>
      
       <li><strong>Assigned To</strong> set to <i>Bastian Waidelich</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-106074-notes"><p>I fail to reproduce this with a slightly modified example (as the escape viewhelper is not longer part of the distribution):</p>


	<p>.h3 Templates/Index.html</p>


<pre>
<code class="html syntaxhl"><span class="CodeRay"><span class="line-numbers"> 1</span><span class="tag">&lt;html&gt;</span>
<span class="line-numbers"> 2</span><span class="tag">&lt;head&gt;</span>
<span class="line-numbers"> 3</span>    <span class="tag">&lt;title&gt;</span>Little bug<span class="tag">&lt;/title&gt;</span>
<span class="line-numbers"> 4</span><span class="tag">&lt;/head&gt;</span>
<span class="line-numbers"> 5</span><span class="tag">&lt;body&gt;</span>
<span class="line-numbers"> 6</span><span class="tag">&lt;ol&gt;</span>
<span class="line-numbers"> 7</span>    <span class="tag">&lt;li&gt;</span><span class="tag">&lt;f:format.htmlspecialchars&gt;</span>I am pre partial<span class="tag">&lt;/f:format.htmlspecialchars&gt;</span><span class="tag">&lt;/li&gt;</span>
<span class="line-numbers"> 8</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{value: 'I am the first node within a partial'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers"> 9</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{value: 'I am not the first but the second node within a partial'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers"><strong>10</strong></span>    <span class="tag">&lt;li&gt;</span><span class="tag">&lt;f:format.htmlspecialchars&gt;</span>I am post partial<span class="tag">&lt;/f:format.htmlspecialchars&gt;</span><span class="tag">&lt;/li&gt;</span>
<span class="line-numbers">11</span><span class="tag">&lt;/ol&gt;</span>
<span class="line-numbers">12</span><span class="tag">&lt;/body&gt;</span>
<span class="line-numbers">13</span><span class="tag">&lt;/html&gt;</span>
</span></code><br /></pre>

	<p>.h3 Partials/test.html</p>


<pre>
<code class="html syntaxhl"><span class="CodeRay"><span class="line-numbers">1</span><span class="tag">&lt;li&gt;</span><span class="tag">&lt;f:format.htmlspecialchars&gt;</span>{value}<span class="tag">&lt;/f:format.htmlspecialchars&gt;</span><span class="tag">&lt;/li&gt;</span>
</span></code><br /></pre>

	<p>Can you please verify this again?</p></div>
  </div>
  

  <div id="change-108098" class="journal has-notes">
    <h4><a href="33551.html#note-3" class="journal-link">#3</a>
    
    <a name="note-3"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2012-03-21" title="2012-03-21 14:44">over 3 years</a> ago</h4>

    
    <div class="wiki" id="journal-108098-notes"><p>Bastian Waidelich wrote:</p>


<blockquote>

	<p>I fail to reproduce this [...]</p>


</blockquote>

	<p>@Stephan can you please confirm this, otherwise I'll close the issue for now</p></div>
  </div>
  

  <div id="change-137906" class="journal has-notes has-details">
    <h4><a href="33551.html#note-4" class="journal-link">#4</a>
    
    <a name="note-4"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2012-10-25" title="2012-10-25 13:58">almost 3 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>Needs Feedback</i> to <i>Closed</i></li>
      
       <li><strong>Affected Flow version</strong> changed from <i>Git master</i> to <i>(any)</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-137906-notes"><p>Closed because of missing feedback</p></div>
  </div>
  

  <div id="change-148128" class="journal has-notes has-details">
    <h4><a href="33551.html#note-5" class="journal-link">#5</a>
    
    <a name="note-5"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/1834">Stephan Schuler</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-01-18" title="2013-01-18 14:31">over 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>Closed</i> to <i>New</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-148128-notes"><p>He Bastian.</p>


	<p>Sorry for not responding, but forge didn't notify me and then I somehow went over this.</p>


	<p>Unfortunatelly the error still persist.</p>


	<p>The Fluid code looks like this:<br /><pre><code class="xml syntaxhl"><span class="CodeRay"><span class="line-numbers">1</span><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="line-numbers">2</span><span class="tag">&lt;rendertest&gt;</span>
<span class="line-numbers">3</span>    <span class="tag">&lt;line&gt;</span><span class="tag">&lt;f:format.htmlentities&gt;</span>first main<span class="tag">&lt;/f:format.htmlentities&gt;</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">4</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Partialtest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{first: 'first partial, first line', second: 'first partial, second line'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers">5</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Partialtest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{first: 'second partial, first line', second: 'second partial, second line'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers">6</span>    <span class="tag">&lt;line&gt;</span><span class="tag">&lt;f:format.htmlentities&gt;</span>last main<span class="tag">&lt;/f:format.htmlentities&gt;</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">7</span><span class="tag">&lt;/rendertest&gt;</span>
<span class="line-numbers">8</span>
</span></code></pre><br /><pre><code class="xml syntaxhl"><span class="CodeRay"><span class="line-numbers">1</span><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="line-numbers">2</span><span class="tag">&lt;rendertest&gt;</span>
<span class="line-numbers">3</span>    <span class="tag">&lt;line&gt;</span><span class="tag">&lt;f:format.htmlentities&gt;</span>first main<span class="tag">&lt;/f:format.htmlentities&gt;</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">4</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Partialtest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{first: 'first partial, first line', second: 'first partial, second line'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers">5</span>    <span class="tag">&lt;f:render</span> <span class="attribute-name">partial</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">Partialtest</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">arguments</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">{first: 'second partial, first line', second: 'second partial, second line'}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
<span class="line-numbers">6</span>    <span class="tag">&lt;line&gt;</span><span class="tag">&lt;f:format.htmlentities&gt;</span>last main<span class="tag">&lt;/f:format.htmlentities&gt;</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">7</span><span class="tag">&lt;/rendertest&gt;</span>
</span></code></pre></p>


	<p>Output of the first request (here the template is not cached, gets rendered and then pushed to the caching directory):<br /><pre><code class="xml syntaxhl"><span class="CodeRay"><span class="line-numbers"> 1</span><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="line-numbers"> 2</span><span class="tag">&lt;rendertest&gt;</span>
<span class="line-numbers"> 3</span>    <span class="tag">&lt;line&gt;</span>first main<span class="tag">&lt;/line&gt;</span>
<span class="line-numbers"> 4</span>    <span class="tag">&lt;line&gt;</span>
<span class="line-numbers"> 5</span>    first partial, first line
<span class="line-numbers"> 6</span>    first partial, second line
<span class="line-numbers"> 7</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers"> 8</span>    <span class="tag">&lt;line&gt;</span>
<span class="line-numbers"> 9</span>    second partial, first line
<span class="line-numbers"><strong>10</strong></span>    second partial, second line
<span class="line-numbers">11</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">12</span>    <span class="tag">&lt;line&gt;</span>second partial, second line<span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">13</span><span class="tag">&lt;/rendertest&gt;</span>
</span></code></pre></p>


	<p>Output of all following requests (here the template has a representation in the Fluid caching directory and so gets only executed):<br /><pre><code class="xml syntaxhl"><span class="CodeRay"><span class="line-numbers"> 1</span><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="line-numbers"> 2</span><span class="tag">&lt;rendertest&gt;</span>
<span class="line-numbers"> 3</span>    <span class="tag">&lt;line&gt;</span>first main<span class="tag">&lt;/line&gt;</span>
<span class="line-numbers"> 4</span>    <span class="tag">&lt;line&gt;</span>
<span class="line-numbers"> 5</span>    first partial, first line
<span class="line-numbers"> 6</span>    first partial, second line
<span class="line-numbers"> 7</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers"> 8</span>    <span class="tag">&lt;line&gt;</span>
<span class="line-numbers"> 9</span>    second partial, first line
<span class="line-numbers"><strong>10</strong></span>    second partial, second line
<span class="line-numbers">11</span><span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">12</span>    <span class="tag">&lt;line&gt;</span>last main<span class="tag">&lt;/line&gt;</span>
<span class="line-numbers">13</span><span class="tag">&lt;/rendertest&gt;</span>
</span></code></pre></p>


	<p>So, nothing changed here.</p>


	<p>Changing from &lt;f:format.htmlentities&gt;{foo}&lt;/f:format.htmletities&gt; to {foo -> f:format.htmlentities} doesn't change anything.</p></div>
  </div>
  

  <div id="change-148323" class="journal has-notes">
    <h4><a href="33551.html#note-6" class="journal-link">#6</a>
    
    <a name="note-6"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/11">Sebastian Kurfuerst</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-01-21" title="2013-01-21 22:15">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-148323-notes"><p>That's very weird behavior. I'd try to reproduce it inside the viewhelpertest packages, I just cannot promise when I'll find the time.</p>


	<p>But that looks like a bug worth fixing ;)</p></div>
  </div>
  

  <div id="change-161530" class="journal has-notes">
    <h4><a href="33551.html#note-7" class="journal-link">#7</a>
    
    <a name="note-7"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/4764">Alexander Berl</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-04-28" title="2013-04-28 12:19">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161530-notes"><p>Some findings:</p>


	<p>I think the problem comes from how ParsingState, alas TemplateParser initializes singleton view helpers vs. how AbstractCompiledTemplate does. If you look closely, the format.htmlentities ViewHelper is of scope singleton, while the format.htmlspecialchars is not - that would explain why Bastian couldn't reproduce the problem.<br />On a closer look, AbstractCompiledTemplate calls viewHelper::resetState on singletons, while TemplateParser doesn't.</p>


	<p>After a fix it should be reviewed if htmlentities needs to stay singleton, also the htmlspecialchars ViewHelper contains special code for the ::compile function, while none of the other format viewhelpers does. This cannot be correct to my understandings.</p></div>
  </div>
  

  <div id="change-161608" class="journal has-notes">
    <h4><a href="33551.html#note-8" class="journal-link">#8</a>
    
    <a name="note-8"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/4764">Alexander Berl</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-04-28" title="2013-04-28 20:40">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161608-notes"><p>I reproduced the bug with the Viewhelpertests, unfortunately the problem isn't only the missing resetState() as I suspected.<br />I also tried simply working around the problem by always using the compiled template even on first load in AbstractTemplateView, but that still doesn't solve the problem oddly enough:<br /><pre>
    public function render($actionName = NULL) {
        $this-&gt;baseRenderingContext-&gt;setControllerContext($this-&gt;controllerContext);
        $this-&gt;templateParser-&gt;setConfiguration($this-&gt;buildParserConfiguration());

        $templateIdentifier = $this-&gt;getTemplateIdentifier($actionName);
        if ($this-&gt;templateCompiler-&gt;has($templateIdentifier)) {
            $parsedTemplate = $this-&gt;templateCompiler-&gt;get($templateIdentifier);
        } else {
            $parsedTemplate = $this-&gt;templateParser-&gt;parse($this-&gt;getTemplateSource($actionName));
            if ($parsedTemplate-&gt;isCompilable()) {
                $this-&gt;templateCompiler-&gt;store($templateIdentifier, $parsedTemplate);
                    // Directly use the compiled template
                $parsedTemplate = $this-&gt;templateCompiler-&gt;get($templateIdentifier);
            }
        }
        ...
    }
</pre></p>


	<p>I hence suspect that there is something other wrong with the context or alike, which I can't really dig into atm.<br />I pushed my Viewhelpertests case at <a class="external" href="../../external.html?link=https://review.typo3.org/20270">https://review.typo3.org/20270</a>, so Bastian and/or Sebastian can work from there.</p>


	<p>I will however add a new issue that just will remove the singleton scope from the htmlentities viewhelper, which will at least be a cosmetic fix for this issue.</p></div>
  </div>
  

  <div id="change-167669" class="journal has-notes has-details">
    <h4><a href="33551.html#note-9" class="journal-link">#9</a>
    
    <a name="note-9"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-05-31" title="2013-05-31 18:14">about 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Assigned To</strong> changed from <i>Bastian Waidelich</i> to <i>Sebastian Kurfuerst</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-167669-notes"><p>Alexander Berl wrote:</p>


<blockquote>

	<p>I reproduced the bug with the Viewhelpertests, unfortunately the problem isn't only the missing resetState() as I suspected.</p>


</blockquote>

	<p>Thanks a lot for preparing this so nicely, Alexander!</p>


	<p>@Sebastian: I'm assigning this to you only for feedback</p>


	<p>I finally came around having a closer look at this again and here's my finding:</p>


	<p>If I remove the @Flow\Scope("singleton") from the HtmlentitiesViewHelper your second test case still fails <strong>during parsing</strong> on the second hit everything works.<br />If I instead remove lines 41 - 46 of the AbstractCompiledTemplate, everything works as expected..</p>


	<p>Here my suggestion:<br />First of all we should get rid of the singleton scope.. HtmlentitiesViewHelper is the only VH that is a singleton – and I can't exactly remember why, probably for performance reasons (this VH is used a lot because it's added automatically by Fluid for HTML templates).<br />To save memory and increase performance we should implement the <strong>CompilableInterface</strong> instead.<br />This looks like that <a class="external" href="../../external.html?link=https://gist.github.com/bwaidelich/e0e34ba95fb2b2306dab">https://gist.github.com/bwaidelich/e0e34ba95fb2b2306dab</a> and fixes the issue for me without further adjustments – we should do that for other core VHs to IMO</p>


	<p>Anyways, I still didn't completely get why the output of the HtmlentitiesViewHelper is "cached" otherwise..</p></div>
  </div>
  

  <div id="change-167670" class="journal has-notes">
    <h4><a href="33551.html#note-10" class="journal-link">#10</a>
    
    <a name="note-10"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-05-31" title="2013-05-31 18:18">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-167670-notes"><p>Bastian Waidelich wrote:</p>


	<p>A little addition:</p>


<blockquote>

	<p>If I remove the @Flow\Scope("singleton") from the HtmlentitiesViewHelper your second test case still fails <strong>during parsing</strong> on the second hit everything works.</p>


</blockquote>

	<p>Obviously, because your second test uses a new ViewHelper "Singleton" that is.. of scope singleton. If I remove that too, everything works too</p></div>
  </div>
  

  <div id="change-168454" class="journal has-notes">
    <h4><a href="33551.html#note-11" class="journal-link">#11</a>
    
    <a name="note-11"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/4764">Alexander Berl</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid/activity?from=2013-06-05" title="2013-06-05 14:41">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-168454-notes"><p>Bastian Waidelich wrote:</p>


<blockquote>

	<p>Bastian Waidelich wrote:</p>


	<p>A little addition:</p>


<blockquote>

	<p>If I remove the @Flow\Scope("singleton") from the HtmlentitiesViewHelper your second test case still fails <strong>during parsing</strong> on the second hit everything works.</p>


</blockquote>

	<p>Obviously, because your second test uses a new ViewHelper "Singleton" that is.. of scope singleton. If I remove that too, everything works too</p>


</blockquote>

	<p>Yes, I added that so there's still a test for the singleton-misbehavior even when the htmlentities viewhelper is not singleton any more :)</p>


<blockquote>

	<p>To save memory and increase performance we should implement the CompilableInterface instead.</p>


</blockquote>

	<p>Is there any profiling-suite or setup you use for verifying the performance/memory influence of changes?</p></div>
  </div>
  




</div>



<div style="clear: both;"></div>
<div class="contextual">


<span class="issue-33551-watcher"></span>


</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:
  <span><a href="../../external.html?link=https://forge.typo3.org/issues/33551.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="33551.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>







<script type="text/javascript">
//<![CDATA[
new ContextMenu('/issues/context_menu')
//]]>
</script>

        
				<div style="clear:both;"></div>
    </div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>
	
<div id="footer">
 Powered by <a href="../../external.html?link=http://www.redmine.org/">Redmine</a> &copy; 2006-2012 Jean-Philippe Lang<br /><br />
 Hosting sponsor:<br /><br />
 <script type="text/javascript">var buttonStyle = "footer-grey-31";</script>
 <script src="../../typo3.org/fileadmin/t3org/images/FM-content/team-pages/server-team/sponsor-banners/sponsors.js"></script>
</div>
</div>

<script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.typo3.org/" : "http://piwik.typo3.org/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 14);
        piwikTracker.trackPageView();
        piwikTracker.enableLinkTracking();
    } catch( err ) {}
</script>
<noscript><span style="visibility: hidden";><img src="../../external.html?link=http://piwik.typo3.org/piwik.php?idsite=14" style="border:0" alt=""/></span></noscript>
</body>

<!-- Mirrored from forge.typo3.org/issues/33551 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 21:59:46 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
</html>

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<!-- Mirrored from forge.typo3.org/issues/63810 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 22:43:42 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Bug #63810: pages SYS_LASTCHANGED does not update when page cache is cleared - Core - TYPO3 Forge</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<link href="../themes/TYPO3/stylesheets/applicationfaba.css?1437165176" media="all" rel="stylesheet" type="text/css" />
<script src="../javascripts/prototypefaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/effectsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/dragdropfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/controlsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/applicationfaba.js?1437165176" type="text/javascript"></script>
<script src="../plugin_assets/flow_design_helpers/javascripts/custom-scriptsf881.js?1437165331" type="text/javascript"></script>

<!--[if IE]>
    <style type="text/css">
      * html body{ width: expression( document.documentElement.clientWidth < 900 ? '900px' : '100%' ); }
      body {behavior: url(/stylesheets/csshover.htc?1437165176);}
    </style>
<![endif]-->
 <link href="../plugin_assets/redmine_backlogs/stylesheets/jquery/jquery.jqplot.minb674.css?1437165332" media="screen" rel="stylesheet" type="text/css" />

<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-1.6.2.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-ui-1.8.16.custom.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jeditable.minib674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.scrollfollowb674.js?1437165332" type="text/javascript"></script>

<!--[if IE]>
<script src="/plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/excanvas.js?1437165332" type="text/javascript"></script>
<![endif]-->
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/jquery.jqplotb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.highlighterb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasTextRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasAxisTickRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.enhancedLegendRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.cookieb674.js?1437165332" type="text/javascript"></script>

<script type="text/javascript"
        src="../rb/server_variables.js">
</script>
<script src="../plugin_assets/redmine_backlogs/javascripts/commonb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/burndownb674.js?1437165332" type="text/javascript"></script>


<style type="text/css">

</style>

<!-- page specific tags -->

    <link href="../../external.html?link=https://forge.typo3.org/issues/63810.atom" rel="alternate" title="Core - Bug #63810: pages SYS_LASTCHANGED does not update when page cache is cleared" type="application/atom+xml" />
    <link href="../themes/TYPO3/stylesheets/scmfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" />
<script src="../javascripts/context_menufaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/context_menufaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /><script src="../javascripts/jstoolbar/jstoolbarfaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/textilefaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/lang/jstoolbar-enfaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/jstoolbarfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /></head>
<body>
<div id="wrapper">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/login" class="login">Sign in</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/account/register" class="register">Register</a></li></ul>    </div>
    
    <ul><li><a href="../../external.html?link=https://forge.typo3.org/" class="home">Home</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects" class="projects">Projects</a></li>
<li><a href="../../external.html?link=http://www.redmine.org/guide" class="help">Help</a></li></ul></div>
      
<div id="header">
    <div id="header-left">
        <div id="header-menu">
            <a href="../../external.html?link=https://forge.typo3.org/" class="start">Start</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms" class="level-0 current sorting-10">TYPO3 CMS</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3neos" class="level-0 sorting-20">TYPO3 Neos</a><a href="../../external.html?link=https://forge.typo3.org/projects/flow3" class="level-0 sorting-20">TYPO3 Flow</a><a href="../../external.html?link=https://forge.typo3.org/projects/team-docteam" class="level-0 sorting-26">Documentation</a><a href="../../external.html?link=https://forge.typo3.org/projects/other" class="level-0 sorting-30">other</a>
        </div>
    </div>
    
    <div id="right-area"  style="">
        <div id="quick-search">
            <form action="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/search" method="get">
            <input name="issues" type="hidden" value="1" />
            <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/search" accesskey="4" style="">Search</a>:
            <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
            </form>
        </div>

        <h1>Core</h1>
        <div id="quicklinks"><p>Development of TYPO3 CMS</p></div>
    </div>
    
    <div id="main-menu">
        <input class="projectsearch placeholder" id="projectname_project" name="projectname[project]" onfocus="this.value = &quot;&quot;; $(this).removeClassName(&quot;placeholder&quot;);" size="30" type="text" value="Project title search" /><div class="auto_complete" id="projectname_project_auto_complete"></div><script type="text/javascript">
//<![CDATA[
var projectname_project_auto_completer = new Ajax.Autocompleter('projectname_project', 'projectname_project_auto_complete', '/projects/auto_complete', {afterUpdateElement:function(element, value) { var identNode = $(value).select(".identifier"); window.location.href="/projects/"+identNode[0].innerHTML }})
//]]>
</script>
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core" class="overview">Overview</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity" class="activity">Activity</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues" class="issues selected">Issues</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/wiki" class="wiki">Wiki</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div class="" id="main">
    <div id="leftmenu">
        <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core" class="level-1 current sorting-10">Core</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3v4-search" class="level-2 sorting-0">Indexed Search</a><a href="../../external.html?link=https://forge.typo3.org/projects/extension-linkvalidator" class="level-2 sorting-0">Linkvalidator</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-releasecycles" class="level-2 sorting-0">Release Cycles</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-team" class="level-2 sorting-0">Team Resources</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3v4-workspaces" class="level-2 sorting-0">Workspaces & Versioning</a><a href="../../external.html?link=https://forge.typo3.org/projects/usability" class="level-2 sorting-10">TYPO3 CMS Usability Team</a><a href="../../external.html?link=https://forge.typo3.org/projects/extensions" class="level-1 sorting-20">Community Extensions</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3v4-distribution" class="level-1 sorting-44">Distributions</a><a href="../../external.html?link=https://forge.typo3.org/projects/cms-feature-requests" class="level-1 sorting-50">Feature-Requests</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-v62" class="level-1 sorting-620">TYPO3 6.2 Projects (+)</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-archived" class="level-1 sorting-1000">(Archived Projects)</a>
    </div>
    <div id="sidebar">        
        
  <h3>Issues</h3>
<a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?set_filter=1">View all issues</a><br />

<a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues/report">Summary</a><br />







<h3>Custom queries</h3><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=219" class="query">Easy tasks</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=391" class="query">FAL Issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=133" class="query">Hierarchical Issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=322" class="query">Most wanted Bugfixes</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=321" class="query">Most wanted Features</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=167" class="query">My open issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=203" class="query">New &amp; Unassigned</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=90" class="query">Open Bugs</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=204" class="query">Recently modified</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=523" class="query">Regressions</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/issues?query_id=459" class="query">Roadmap v7</a>



  
    <div id="watchers">
      

<h3>Watchers (4)</h3>

<ul><li><a href="../../external.html?link=https://forge.typo3.org/users/3351">Markus Klein</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/users/102">Jo Hasenau</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/users/33">Mathias Schreiber</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/users/2158">Florian Seirer</a></li></ul>

    </div>
  

        
    </div>
    
    <div id="content">
				
        <div class="contextual">


<span class="issue-63810-watcher"></span>


</div>


<h2>Bug #63810</h2>

<div class="issue status-2 priority-1 child details">
  

  

<div class="subject">
<div><p><a href="63815.html" class="issue status-1 priority-2 parent">Story #63815</a>: Reduce communication between server and client</p><div><h3>pages SYS_LASTCHANGED does not update when page cache is cleared</h3></div></div>
</div>
        <p class="author">
        Added by <a href="../../external.html?link=https://forge.typo3.org/users/324">Michiel Roos</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 12:06">8 months</a> ago.
        
        Updated <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 16:00">8 months</a> ago.
        
        </p>

<table class="attributes">
<tr>
    <th class="status">Status:</th><td class="status">Accepted</td>
    <th class="start-date">Start date:</th><td class="start-date">2014-12-12</td>
</tr>
<tr>
    <th class="priority">Priority:</th><td class="priority">Must have</td>
    <th class="due-date">Due date:</th><td class="due-date"></td>
</tr>
<tr>
    <th class="assigned-to">Assigned To:</th><td class="assigned-to"><a href="../../external.html?link=https://forge.typo3.org/users/33">Mathias Schreiber</a></td>
    <th class="progress">% Done:</th><td class="progress"><table class="progress" style="width: 80px;"><tr><td class="todo" style="width: 100%;"></td></tr></table><p class="pourcent">0%</p></td>
</tr>
<tr>
    <th class="category">Category:</th><td class="category">-</td>
    
    <th class="spent-time">Spent time:</th>
    <td class="spent-time">-</td>
    
</tr>
<tr>
    <th class="fixed-version">Target version:</th><td class="fixed-version">-</td>
    
</tr>
<tr>
	<th>TYPO3 Version:</th><td>6.2</td>
	<th>Is Regression:</th><td>No</td>
</tr>
<tr>
	<th>PHP Version:</th><td>5.4</td>
	<th>Sprint Focus:</th><td></td>
</tr>
<tr>
	<th>Complexity:</th><td></td>
</tr>


</table>

<hr />

  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>When the frontend cache is cleared, the SYS_LASTCHANGED value is not updated. This means that the 'Last Modified' header sent out by TYPO3 will stay unchanged for all the pages. All visitors holding a cached page in their browser cache will keep this page forever. They will check back with the server after the page 'expires' from their cache, but will never fetch a new version because the server says the page has not been modified.</p>
  </div>

<div class="attachments">

<p><a href="../attachments/download/28105/Browser%20caching.pdf" class="icon icon-attachment">Browser caching.pdf</a>  
  
  <span class="size">(71.5 kB)</span>
  
  
    <span class="author">Patrick Broens, 2014-12-16 11:47</span>
  
  </p>

</div>







<hr />
<div id="relations">
<div class="contextual">

</div>

<p><strong>Related issues</strong></p>


<form>
<table class="list issues">

<tr class="issue hascontextmenu" id="relation-12110">
<td class="checkbox"><input name="ids[]" type="checkbox" value="63798" /></td>
<td class="subject">related to 
    Core - 
    <a href="63798.html" class="issue status-1 priority-1 child">Bug #63798</a>: SYS_LASTCHANGED does not updated when TCEMAIN.clearCacheC...
</td>
<td class="status">New</td>
<td class="start_date">2014-12-12</td>
<td class="due_date"></td>
<td class="buttons"></td>
</tr>

<tr class="issue hascontextmenu" id="relation-12111">
<td class="checkbox"><input name="ids[]" type="checkbox" value="56868" /></td>
<td class="subject">related to 
    Grid Elements - 
    <a href="56868.html" class="issue status-5 priority-1">Feature #56868</a>: Update SYS_LASTCHANGED
</td>
<td class="status">On Hold</td>
<td class="start_date">2014-03-13</td>
<td class="due_date"></td>
<td class="buttons"></td>
</tr>

</table>
</form>


<form action="../../external.html?link=https://forge.typo3.org/issues/63810/relations" id="new-relation-form" method="post" onsubmit="new Ajax.Request('/issues/63810/relations', {asynchronous:true, evalScripts:true, method:'post', onComplete:function(request){Form.Element.focus('relation_issue_to_id');}, parameters:Form.serialize(this)}); return false;" style="display: none;"><div style="margin:0;padding:0;display:inline"><input name="authenticity_token" type="hidden" value="IjgAk+sryuS7AAkPn7/ITUV652f6cwFBHN6GNTvW7o8=" /></div>


<p><select id="relation_relation_type" name="relation[relation_type]" onchange="setPredecessorFieldsVisibility();"><option value="relates">related to</option>
<option value="duplicates">duplicates</option>
<option value="duplicated">duplicated by</option>
<option value="blocks">blocks</option>
<option value="blocked">blocked by</option>
<option value="precedes">precedes</option>
<option value="follows">follows</option></select>
Issue #<input id="relation_issue_to_id" name="relation[issue_to_id]" size="10" type="text" />
<span id="predecessor_fields" style="display:none;">
Delay: <input id="relation_delay" name="relation[delay]" size="3" type="text" /> days
</span>
<input name="commit" type="submit" value="Add" />
<a href="#" onclick="Element.toggle('new-relation-form'); this.blur(); return false;">Cancel</a>
</p>

<div id="related_issue_candidates" class="autocomplete"></div>
<script type="text/javascript">
//<![CDATA[
observeRelatedIssueField('/issues/auto_complete?id=63810&amp;project_id=typo3cms-core')
//]]>
</script>

<script type="text/javascript">
//<![CDATA[
setPredecessorFieldsVisibility();
//]]>
</script>

</form>

</div>


</div>




<div id="history">
<h3>History</h3>

  <div id="change-240067" class="journal has-notes">
    <h4><a href="63810.html#note-1" class="journal-link">#1</a>
    
    <a name="note-1"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/3351">Markus Klein</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 12:22">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240067-notes"><p>Can you debug that?</p>


Some entry points:
	<ul>
	<li>\TYPO3\CMS\Frontend\Controller\TypoScriptFrontendController::setSysLastChanged</li>
		<li>\TYPO3\CMS\Frontend\Controller\TypoScriptFrontendController::fetch_the_id (very bottom)</li>
		<li>\TYPO3\CMS\Frontend\ContentObject\ContentObjectRenderer::lastChanged</li>
	</ul></div>
  </div>
  

  <div id="change-240075" class="journal has-notes">
    <h4><a href="63810.html#note-2" class="journal-link">#2</a>
    
    <a name="note-2"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/324">Michiel Roos</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 12:33">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240075-notes"><p>Mitigation code:</p>


	<p>ext_localconf.php:<br /><pre>
$GLOBALS['TYPO3_CONF_VARS']['SC_OPTIONS']['t3lib/class.t3lib_tcemain.php']['clearCachePostProc'][] =
    'MyComp\\SomeModule\\DataHandler\\ProcessClearCacheQueue-&gt;clearCacheCmd';
</pre></p>


	<p>Classes/DataHandler/ProcessClearCacheQueue.php<br /><pre>
&lt;?php
namespace MyComp\SomeModule\DataHandler;

/**
 * Class ProcessClearCacheQueue
 *
 * @package MyComp\SomeModule\DataHandler
 */
class ProcessClearCacheQueue {

    /**
     * Update SYS_LASTCHANGED of pages when clearCacheCmd is called
     *
     * This hook may be called from two locations:
     * 1). \TYPO3\CMS\Core\DataHandling\DataHandler::processClearCacheQueue()
     *     In this case the parameters contain:
     *     array(
     *         'table' =&gt; $table,
     *         'uid' =&gt; $uid,
     *         'uid_page' =&gt; $pageUid,
     *         'TSConfig' =&gt; $TSConfig
     *     );
     *     We can just update the SYS_LASTCHANGED for the page with $pageUid.
     *
     * 2). \TYPO3\CMS\Core\DataHandling\DataHandler::clear_cacheCmd()
     *     array(
     *         'cacheCmd' =&gt; strtolower($cacheCmd)
     *     );
     *     In this case we need to figure out the actual cacheCmd and clear the
     *     affected pages.
     *
     * @param array $parameters
     * @param \TYPO3\CMS\Core\DataHandling\DataHandler $parent
     *
     * @return void
     */
    public function clearCacheCmd($parameters, $parent) {
        /** @var \TYPO3\CMS\Core\Database\DatabaseConnection $databaseConnection */
        $databaseConnection = $GLOBALS['TYPO3_DB'];
        $now = time();
        if (is_array($parameters) AND isset($parameters['uid_page'])) {
            $databaseConnection-&gt;exec_UPDATEquery('pages', 'uid=' . (int)$parameters['uid_page'], array('SYS_LASTCHANGED' =&gt; $now));
        } else {

            // Clear cache for either ALL pages or ALL tables!
            switch ($parameters['cacheCmd']) {
                case 'pages':
                case 'all':
                case 'temp_cached':
                case 'system':
                    $databaseConnection-&gt;exec_UPDATEquery('pages', '1=1', array('SYS_LASTCHANGED' =&gt; $now));
                    break;
                default:
            }

            // Clear cache for a page ID!
            if (\TYPO3\CMS\Core\Utility\MathUtility::canBeInterpretedAsInteger($parameters['cacheCmd'])) {
                $databaseConnection-&gt;exec_UPDATEquery('pages', 'uid=' . (int)$parameters['cacheCmd'], array('SYS_LASTCHANGED' =&gt; $now));
            }

            // flush cache by tag
            if (strpos($parameters['cacheCmd'], 'cachetag:') === 0) {
                $pageIds = array();
                $cacheTags = explode(',', $parameters['cacheCmd']);
                foreach($cacheTags as $tag) {
                    if (strpos($tag, 'pageId_') === 0) {
                        $pageIds[] = (int)strrchr($tag, '_');
                    }
                }
                if (count($pageIds)) {
                    $databaseConnection-&gt;exec_UPDATEquery('pages', 'uid IN(' . implode(',', $pageIds) . ')', array('SYS_LASTCHANGED' =&gt; $now));
                }
            }
        }
    }
}
</pre></p></div>
  </div>
  

  <div id="change-240080" class="journal has-notes">
    <h4><a href="63810.html#note-3" class="journal-link">#3</a>
    
    <a name="note-3"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 12:56">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240080-notes"><p>I can affirm this behaviour. Strange that nobody ever did notify this.</p></div>
  </div>
  

  <div id="change-240088" class="journal has-notes">
    <h4><a href="63810.html#note-4" class="journal-link">#4</a>
    
    <a name="note-4"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/3351">Markus Klein</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 13:47">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240088-notes"><p>Keep in mind that $parameters['cacheCmd'] is only a single keyword. So no need to explode on comma.</p></div>
  </div>
  

  <div id="change-240093" class="journal has-notes">
    <h4><a href="63810.html#note-5" class="journal-link">#5</a>
    
    <a name="note-5"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 14:02">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240093-notes"><p>Some clarification is needed:</p>


The issue is for some topics:
	<ul>
	<li>Cached lists which are taking records from another place (like news and a storage folder for the items)</li>
		<li>Changing TypoScript, templates and such, which is not a change in the actual page.</li>
	</ul>


How browser caching is working:
	<ul>
	<li>Browser gets page A served</li>
		<li>Page A has an "expires" time and a "Last-Modified" header</li>
		<li>Browser caches the page as long as expires still active</li>
		<li>If expires has run out, the browser checks again at server with the previous Last-Modified</li>
		<li>Server tells that Last-Modified has not changed, so browser will again serve from cache</li>
	</ul>


	<p>When changing something which is not directly related to the page, like TypoScript or a template, SYS_LASTCHANGED will not change</p>


	<p>We, as developers or integrators, are so used by reloading a page or clearing the browser cache, a visitor will not do this. Reloading a page will indeed refresh the page by getting a new copy from the server, but visitors are looking at a local cached version.</p></div>
  </div>
  

  <div id="change-240113" class="journal has-notes">
    <h4><a href="63810.html#note-6" class="journal-link">#6</a>
    
    <a name="note-6"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/324">Michiel Roos</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 15:36">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240113-notes"><p>Here is the fixed 'flush by tag' code:<br /><pre>
            // flush cache by tag
            if (strpos($parameters['cacheCmd'], 'cachetag:pageid_') === 0) {
                $pageId = (int)substr(strrchr($parameters['cacheCmd'], '_'), 1);
                $databaseConnection-&gt;exec_UPDATEquery('pages', 'uid = ' . $pageId, array('SYS_LASTCHANGED' =&gt; $now));
            }

</pre></p></div>
  </div>
  

  <div id="change-240115" class="journal has-details">
    <h4><a href="63810.html#note-7" class="journal-link">#7</a>
    
    <a name="note-7"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/3767">Alexander Opitz</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-12" title="2014-12-12 15:37">8 months</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Parent task</strong> set to <i>#63815</i></li>
      
    </ul>
    
    
  </div>
  

  <div id="change-240731" class="journal has-notes">
    <h4><a href="63810.html#note-8" class="journal-link">#8</a>
    
    <a name="note-8"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-15" title="2014-12-15 09:25">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240731-notes"><p>Did some investigation in this topic today. Seems we have a hidden feature which must be used by content elements which run into problems like the one described. Look at \TYPO3\CMS\Frontend\ContentObject\ContentObjectRenderer::lastChanged(). With this method it is possible to set a timestamp higher than the pages SYS_LASTCHANGED from the content element itself. When the page is being rendered this value will be written to the pages DB entry in \TYPO3\CMS\Frontend\Controller\TypoScriptFrontendController::setSysLastChanged().</p>


	<p>So it is up to the content element if the "Last Modified" header needs to be updated, which is exactly what we want.</p>


	<p>This solves the problem partly. No need to set TCEMAIN.clearCacheCmd(). Still, when, for instance, a new template is added, we still need the change in SYS_LASTCHANGED when the cache is cleared for page, all or on tag.</p>


	<p>Using above method needs to be documented for extension builders</p></div>
  </div>
  

  <div id="change-240733" class="journal has-details">
    <h4><a href="63810.html#note-9" class="journal-link">#9</a>
    
    <a name="note-9"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/33">Mathias Schreiber</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-15" title="2014-12-15 09:29">8 months</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>New</i> to <i>Accepted</i></li>
      
       <li><strong>Assigned To</strong> set to <i>Mathias Schreiber</i></li>
      
    </ul>
    
    
  </div>
  

  <div id="change-240858" class="journal has-notes">
    <h4><a href="63810.html#note-10" class="journal-link">#10</a>
    
    <a name="note-10"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-15" title="2014-12-15 17:14">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-240858-notes"><p>There are some other points where SYS_LASTCHANGED should be taken into account:</p>


Not taken into account:
	<ul>
	<li>starttime and endtime of pages and content</li>
		<li>Menu's (Pages/Content should be checked for tstamp)</li>
		<li>Fluid (File changes)</li>
		<li>FILE (File changes)</li>
		<li>FILES (File changes)</li>
		<li>FLUIDTEMPLATE (File changes)</li>
		<li>IMAGE (File changes)</li>
		<li>IMG_RESOURCE (File changes)</li>
		<li>IMGTEXT (File changes)</li>
		<li>MEDIA (File changes)</li>
		<li>MULTIMEDIA (File changes)</li>
		<li>QTOBJECT (File changes)</li>
		<li>SVG (File changes)</li>
		<li>SWFOBJECT (File changes)</li>
		<li>TEMPLATE (File changes)</li>
		<li>All file changes for external files like JS, CSS, HTML, TypoScript</li>
		<li>Changes up in rootline, like TypoScript changes</li>
	</ul>


Taken into account:
	<ul>
	<li>RECORDS</li>
		<li>CONTENT</li>
	</ul></div>
  </div>
  

  <div id="change-241043" class="journal has-notes">
    <h4><a href="63810.html#note-11" class="journal-link">#11</a>
    
    <a name="note-11"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/102">Jo Hasenau</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 11:39">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-241043-notes"><p>We discussed that issue in our team today and the idea came up to solve this issue with a different approach, although I have to admit that I am not completeley convinced yet.</p>


	<p>The idea: Actually SYS_LASTCHANGED should not be used to mark the "last modified" header for the stuff TYPO3 delivers at all, since it marks active changes by the users and is used for frontend output like "this page has been modified 12/13/14".</p>


	<p>This issues is not about this particular timestamp though, since the "last modified" header should contain the time of the last creation of the cache file anyway.<br />So while the SYS_LASTCHANGED field might still need to be updated by more actions, its value should be irrelevant for the header until the cache will be created the next time.<br />And even if the cache would be created another time without changes to SYS_LASTCHANGED, it should still deliver another value for "last modified".</p>


	<p>This way SYS_LASTCHANGED itself would not have to be updated when changing JS, CSS, HTML or TypoScript, but it could still be updated after actions of "real" editors.</p></div>
  </div>
  

  <div id="change-241045" class="journal has-notes has-details">
    <h4><a href="63810.html#note-12" class="journal-link">#12</a>
    
    <a name="note-12"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 11:47">8 months</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>File</strong> <a href="../attachments/download/28105/Browser%20caching.pdf">Browser caching.pdf</a> added</li>
      
    </ul>
    
    <div class="wiki" id="journal-241045-notes"><p>SYS_LASTCHANGED was introduced by Kasper in 2003 or before, exactly with the purpose to track all page related changes. It was not really intended to be displayed in the frontend. Probably that is why he made the field name uppercase ;-)</p>


	<p>I do not agree that the Last-Modified header should contain the last creation date of the the cache file. That is what's the "Date" header is already doing. Last-Modified is about content, not about caching.</p>


	<p>I've just written a document describing the whole problem. I'll attach it here as well.</p></div>
  </div>
  

  <div id="change-241049" class="journal has-notes">
    <h4><a href="63810.html#note-13" class="journal-link">#13</a>
    
    <a name="note-13"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/102">Jo Hasenau</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 11:52">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-241049-notes"><p>Actually I agree with you, Patrick, since this was my point in the discussion here as well.</p></div>
  </div>
  

  <div id="change-241147" class="journal has-notes">
    <h4><a href="63810.html#note-14" class="journal-link">#14</a>
    
    <a name="note-14"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/50">Helmut Hummel</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 15:31">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-241147-notes"><p>Patrick Broens wrote:</p>


<blockquote>

	<p>I do not agree that the Last-Modified header should contain the last creation date of the the cache file. That is what's the "Date" header is already doing. Last-Modified is about content, not about caching.</p>


</blockquote>

	<p>While I agree that the Last-Modified header <strong>should</strong> be close to the modification date of the entity, I disagree that it <strong>must</strong> be.<br />See the specification: <a class="external" href="../../external.html?link=http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec14.html</a> which clearly supports this view.</p>


	<p>For now, we have two easy options:</p>


	<p>1. Remove the Last-Modified header completely (it is optional)<br />2. Set it to the cache creation date to avoid caching issues mentioned above</p>


	<p>For the future we <strong>may</strong> implement a solution which <strong>must</strong> be independent from cache clearing, which calculated SYS_LAST_CHANGED of a page correctly. I consider this a "nightmare" task with our current code base and (missing) API, as too many things can happen in the system which changes the state of a "page" entity (starting but not ending with extensions or even the core directly modifying the database), that we can never completely detect all state changes.</p></div>
  </div>
  

  <div id="change-241152" class="journal has-notes">
    <h4><a href="63810.html#note-15" class="journal-link">#15</a>
    
    <a name="note-15"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/285">Patrick Broens</a> <a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms-core/activity?from=2014-12-16" title="2014-12-16 16:00">8 months</a> ago</h4>

    
    <div class="wiki" id="journal-241152-notes"><p>Hi Helmut,</p>


	<p>If setting it to the cache entry date, it will never be called by the browser, because it first lets the cache expire and then it will look if there is a modification. So it is useless that way.</p></div>
  </div>
  




</div>



<div style="clear: both;"></div>
<div class="contextual">


<span class="issue-63810-watcher"></span>


</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:
  <span><a href="../../external.html?link=https://forge.typo3.org/issues/63810.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="63810.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>







<script type="text/javascript">
//<![CDATA[
new ContextMenu('/issues/context_menu')
//]]>
</script>

        
				<div style="clear:both;"></div>
    </div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>
	
<div id="footer">
 Powered by <a href="../../external.html?link=http://www.redmine.org/">Redmine</a> &copy; 2006-2012 Jean-Philippe Lang<br /><br />
 Hosting sponsor:<br /><br />
 <script type="text/javascript">var buttonStyle = "footer-grey-31";</script>
 <script src="../../typo3.org/fileadmin/t3org/images/FM-content/team-pages/server-team/sponsor-banners/sponsors.js"></script>
</div>
</div>

<script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.typo3.org/" : "http://piwik.typo3.org/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 14);
        piwikTracker.trackPageView();
        piwikTracker.enableLinkTracking();
    } catch( err ) {}
</script>
<noscript><span style="visibility: hidden";><img src="../../external.html?link=http://piwik.typo3.org/piwik.php?idsite=14" style="border:0" alt=""/></span></noscript>
</body>

<!-- Mirrored from forge.typo3.org/issues/63810 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 22:43:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
</html>

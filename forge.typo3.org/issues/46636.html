<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">

<!-- Mirrored from forge.typo3.org/issues/46636 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 22:08:17 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title>Bug #46636: Authentication does not work any longer without redirects - TYPO3.Flow - TYPO3 Forge</title>
<meta name="description" content="Redmine" />
<meta name="keywords" content="issue,bug,tracker" />
<link href="../themes/TYPO3/stylesheets/applicationfaba.css?1437165176" media="all" rel="stylesheet" type="text/css" />
<script src="../javascripts/prototypefaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/effectsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/dragdropfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/controlsfaba.js?1437165176" type="text/javascript"></script>
<script src="../javascripts/applicationfaba.js?1437165176" type="text/javascript"></script>
<script src="../plugin_assets/flow_design_helpers/javascripts/custom-scriptsf881.js?1437165331" type="text/javascript"></script>

<!--[if IE]>
    <style type="text/css">
      * html body{ width: expression( document.documentElement.clientWidth < 900 ? '900px' : '100%' ); }
      body {behavior: url(/stylesheets/csshover.htc?1437165176);}
    </style>
<![endif]-->
 <link href="../plugin_assets/redmine_backlogs/stylesheets/jquery/jquery.jqplot.minb674.css?1437165332" media="screen" rel="stylesheet" type="text/css" />

<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-1.6.2.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery-ui-1.8.16.custom.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jeditable.minib674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.scrollfollowb674.js?1437165332" type="text/javascript"></script>

<!--[if IE]>
<script src="/plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/excanvas.js?1437165332" type="text/javascript"></script>
<![endif]-->
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/jquery.jqplotb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.highlighterb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasTextRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.canvasAxisTickRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.jqplot/plugins/jqplot.enhancedLegendRenderer.minb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/jquery/jquery.cookieb674.js?1437165332" type="text/javascript"></script>

<script type="text/javascript"
        src="../rb/server_variables.js">
</script>
<script src="../plugin_assets/redmine_backlogs/javascripts/commonb674.js?1437165332" type="text/javascript"></script>
<script src="../plugin_assets/redmine_backlogs/javascripts/burndownb674.js?1437165332" type="text/javascript"></script>


<style type="text/css">

#header #right-area, #header #right-area h1, #header #right-area a {
  color:transparent;
}

</style>

<!-- page specific tags -->

    <link href="../../external.html?link=https://forge.typo3.org/issues/46636.atom" rel="alternate" title="TYPO3.Flow - Bug #46636: Authentication does not work any longer without redirects" type="application/atom+xml" />
    <link href="../themes/TYPO3/stylesheets/scmfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" />
<script src="../javascripts/context_menufaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/context_menufaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /><script src="../javascripts/jstoolbar/jstoolbarfaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/textilefaba.js?1437165176" type="text/javascript"></script><script src="../javascripts/jstoolbar/lang/jstoolbar-enfaba.js?1437165176" type="text/javascript"></script><link href="../stylesheets/jstoolbarfaba.css?1437165176" media="screen" rel="stylesheet" type="text/css" /></head>
<body>
<div id="wrapper">
<div id="top-menu">
    <div id="account">
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/login" class="login">Sign in</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/account/register" class="register">Register</a></li></ul>    </div>
    
    <ul><li><a href="../../external.html?link=https://forge.typo3.org/" class="home">Home</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects" class="projects">Projects</a></li>
<li><a href="../../external.html?link=http://www.redmine.org/guide" class="help">Help</a></li></ul></div>
      
<div id="header">
    <div id="header-left">
        <div id="header-menu">
            <a href="../../external.html?link=https://forge.typo3.org/" class="start">Start</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3cms" class="level-0 sorting-10">TYPO3 CMS</a><a href="../../external.html?link=https://forge.typo3.org/projects/typo3neos" class="level-0 sorting-20">TYPO3 Neos</a><a href="../../external.html?link=https://forge.typo3.org/projects/flow3" class="level-0 current sorting-20">TYPO3 Flow</a><a href="../../external.html?link=https://forge.typo3.org/projects/team-docteam" class="level-0 sorting-26">Documentation</a><a href="../../external.html?link=https://forge.typo3.org/projects/other" class="level-0 sorting-30">other</a>
        </div>
    </div>
    
    <div id="right-area"  style="background-image:url(../headerimages/16.jpg);">
        <div id="quick-search">
            <form action="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/search" method="get">
            <input name="issues" type="hidden" value="1" />
            <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/search" accesskey="4" style="color:transparent">Search</a>:
            <input accesskey="f" class="small" id="q" name="q" size="20" type="text" />
            </form>
        </div>

        <h1>TYPO3.Flow</h1>
        <div id="quicklinks"></div>
    </div>
    
    <div id="main-menu">
        <input class="projectsearch placeholder" id="projectname_project" name="projectname[project]" onfocus="this.value = &quot;&quot;; $(this).removeClassName(&quot;placeholder&quot;);" size="30" type="text" value="Project title search" /><div class="auto_complete" id="projectname_project_auto_complete"></div><script type="text/javascript">
//<![CDATA[
var projectname_project_auto_completer = new Ajax.Autocompleter('projectname_project', 'projectname_project_auto_complete', '/projects/auto_complete', {afterUpdateElement:function(element, value) { var identNode = $(value).select(".identifier"); window.location.href="/projects/"+identNode[0].innerHTML }})
//]]>
</script>
        <ul><li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow" class="overview">Overview</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity" class="activity">Activity</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/roadmap" class="roadmap">Roadmap</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues" class="issues selected">Issues</a></li>
<li><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/repository" class="repository">Repository</a></li></ul>
    </div>
</div>

<div class="" id="main">
    <div id="leftmenu">
        <a href="../../external.html?link=https://forge.typo3.org/projects/flow3-distribution-base" class="level-1 current sorting-0">TYPO3 Flow Base Distribution</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-eel" class="level-2 sorting-0">TYPO3.Eel</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow" class="level-2 current sorting-0">TYPO3.Flow</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-fluid" class="level-2 sorting-0">TYPO3.Fluid</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-kickstart" class="level-2 sorting-0">TYPO3.Kickstart</a><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-welcome" class="level-2 sorting-0">TYPO3.Welcome</a><a href="../../external.html?link=https://forge.typo3.org/projects/packages" class="level-1 sorting-10">Packages</a><a href="../../external.html?link=https://forge.typo3.org/projects/flow3-apps" class="level-1 sorting-30">Applications</a>
    </div>
    <div id="sidebar">        
        
  <h3>Issues</h3>
<a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?set_filter=1">View all issues</a><br />

<a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues/report">Summary</a><br />







<h3>Custom queries</h3><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=133" class="query">Hierarchical Issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=322" class="query">Most wanted Bugfixes</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=321" class="query">Most wanted Features</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=167" class="query">My open issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=203" class="query">New &amp; Unassigned</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=90" class="query">Open Bugs</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=375" class="query">Open documentation issues</a><br /><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/issues?query_id=204" class="query">Recently modified</a>



  
    <div id="watchers">
      

<h3>Watchers (1)</h3>

<ul><li><a href="../../external.html?link=https://forge.typo3.org/users/38099">Sebastian Düvel</a></li></ul>

    </div>
  

        
    </div>
    
    <div id="content">
				
        <div class="contextual">


<span class="issue-46636-watcher"></span>


</div>


<h2>Bug #46636</h2>

<div class="issue status-7 priority-1 closed details">
  

  

<div class="subject">
<div><h3>Authentication does not work any longer without redirects</h3></div>
</div>
        <p class="author">
        Added by <a href="../../external.html?link=https://forge.typo3.org/users/37356">Marco Falkenberg</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-03-25" title="2013-03-25 09:58">over 2 years</a> ago.
        
        Updated <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 18:35">about 2 years</a> ago.
        
        </p>

<table class="attributes">
<tr>
    <th class="status">Status:</th><td class="status">Resolved</td>
    <th class="start-date">Start date:</th><td class="start-date">2013-03-25</td>
</tr>
<tr>
    <th class="priority">Priority:</th><td class="priority">Must have</td>
    <th class="due-date">Due date:</th><td class="due-date"></td>
</tr>
<tr>
    <th class="assigned-to">Assigned To:</th><td class="assigned-to"><a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a></td>
    <th class="progress">% Done:</th><td class="progress"><table class="progress" style="width: 80px;"><tr><td class="closed" style="width: 100%;"></td></tr></table><p class="pourcent">100%</p></td>
</tr>
<tr>
    <th class="category">Category:</th><td class="category">Security</td>
    
    <th></th>
    <td></td>
    
</tr>
<tr>
    <th class="fixed-version">Target version:</th><td class="fixed-version"><a href="../../external.html?link=https://forge.typo3.org/versions/1966">TYPO3 Flow Base Distribution - 2.0</a></td>
    
</tr>
<tr>
	<th>PHP Version:</th><td></td>
	<th>Complexity:</th><td></td>
</tr>
<tr>
	<th>Has patch:</th><td>No</td>
	<th>Affected Flow version:</th><td>Flow 2.0.0 beta 1</td>
</tr>


</table>

<hr />

  <div class="contextual">
  
  </div>

  <p><strong>Description</strong></p>
  <div class="wiki">
  <p>After applying the patch <a href="46352.html" class="issue status-7 priority-2 closed" title="Roles in SecurityContext should be kept until tokens change (Resolved)">#46352</a> authentication via HTTP-Basic (PersistedUsernamePasswordProvider &#38; UsernamePasswordHttpBasic-Token) throws</p>


	<p>#1222268609: Access denied (0 denied, 0 granted, 1 abstained)</p>
  </div>









</div>


<div id="issue-changesets">
<h3>Associated revisions</h3>

    <div class="changeset odd">
    <p><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/repository/revisions/e06e0f2dd6eb565f00ae535c780ab13b74de8f92" title="Revision e06e0f2d">Revision e06e0f2d</a><br />
        <span class="author">Added by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 17:42">about 2 years</a> ago</span></p>
    <div class="wiki">
        <p>[BUGFIX] Authentication does not work any longer without redirects</p>


	<p>This fixes a regression that made the authenticated roles only available<br />in the security context after a redirect following authentication.</p>


	<p>Background:</p>


	<p>This is a regression introduced with the 1st level cache added in<br />Id256b168ff9c6aa4cac8da8957ada237f9236c71 but the actual problem is<br />that the PersistenceQueryRewritingAspect initializes the security<br />context if it was not initialized before (since change<br />I44838de1503cbe49cf3fee51921b731bfaa0cfc5) when intercepting QOM<br />queries setting the context roles to "Anonymous" and "Everybody".</p>


	<p>This change adds a new method Context::withoutAuthorizationChecks()<br />that allows you temporarily disable authorization related interceptors<br />e.g. PolicyEnforcement and PersistenceQueryRewriting aspects in order<br />to be able to circumvent authorization in low level operations (for<br />example to fetch the current account in an AuthenticationProvider).</p>


	<p>Usage::</p>


	<pre><code>$this-&gt;securityContext-&gt;withoutAuthorizationChecks(<br />   function ($accountRepository, $username, $providerName, &#38;$account) {<br />     // this will disable the PersistenceQueryRewritingAspect for this one call<br />     $account = $accountRepository<br />       -&gt;findActiveByAccountIdentifierAndAuthenticationProviderName($username, $providerName)<br />   }<br /> );</code></pre>


	<p>Change-Id: Ib31cd6bcf10504670439d4c700dda0b14e512d80<br />Related: <a href="46352.html" class="issue status-7 priority-2 closed" title="Roles in SecurityContext should be kept until tokens change (Resolved)">#46352</a><br />Fixes: <a href="46636.html" class="issue status-7 priority-1 closed" title="Authentication does not work any longer without redirects (Resolved)">#46636</a><br />Releases: master, 2.0</p>
    </div>
    </div>

    <div class="changeset even">
    <p><a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/repository/revisions/b964e06bb30ce6eb6e2efcae8723d6b762876139" title="Revision b964e06b">Revision b964e06b</a><br />
        <span class="author">Added by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 17:46">about 2 years</a> ago</span></p>
    <div class="wiki">
        <p>[BUGFIX] Authentication does not work any longer without redirects</p>


	<p>This fixes a regression that made the authenticated roles only available<br />in the security context after a redirect following authentication.</p>


	<p>Background:</p>


	<p>This is a regression introduced with the 1st level cache added in<br />Id256b168ff9c6aa4cac8da8957ada237f9236c71 but the actual problem is<br />that the PersistenceQueryRewritingAspect initializes the security<br />context if it was not initialized before (since change<br />I44838de1503cbe49cf3fee51921b731bfaa0cfc5) when intercepting QOM<br />queries setting the context roles to "Anonymous" and "Everybody".</p>


	<p>This change adds a new method Context::withoutAuthorizationChecks()<br />that allows you temporarily disable authorization related interceptors<br />e.g. PolicyEnforcement and PersistenceQueryRewriting aspects in order<br />to be able to circumvent authorization in low level operations (for<br />example to fetch the current account in an AuthenticationProvider).</p>


	<p>Usage::</p>


	<pre><code>$this-&gt;securityContext-&gt;withoutAuthorizationChecks(<br />   function ($accountRepository, $username, $providerName, &#38;$account) {<br />     // this will disable the PersistenceQueryRewritingAspect for this one call<br />     $account = $accountRepository<br />       -&gt;findActiveByAccountIdentifierAndAuthenticationProviderName($username, $providerName)<br />   }<br /> );</code></pre>


	<p>Change-Id: Ib31cd6bcf10504670439d4c700dda0b14e512d80<br />Related: <a href="46352.html" class="issue status-7 priority-2 closed" title="Roles in SecurityContext should be kept until tokens change (Resolved)">#46352</a><br />Fixes: <a href="46636.html" class="issue status-7 priority-1 closed" title="Authentication does not work any longer without redirects (Resolved)">#46636</a><br />Releases: master, 2.0</p>
    </div>
    </div>


</div>



<div id="history">
<h3>History</h3>

  <div id="change-161215" class="journal has-notes">
    <h4><a href="46636.html#note-1" class="journal-link">#1</a>
    
    <a name="note-1"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/37356">Marco Falkenberg</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-25" title="2013-04-25 10:32">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161215-notes"><p>After some debugging I could locate the problem. The thing is that the Security\Context never will be informed about a new authenticated token, and under some circumstances Security\Context->getRoles() will be called <strong>before</strong> the token is authenticated.</p>


	<p>This happens e.g. when you use a PersistedUsernamePasswordProvider. It tries to fetch a user from persistence. Then the PersistenceQueryRewritingAspect hooks in which calls Security\Context->getRoles() and... bam: The default roles Everybody and Anonymous are locked. And when UsernamePasswordHttpBasic-authentication is used, the authentication and access to the protected resource afterwards occurs in one request.</p></div>
  </div>
  

  <div id="change-161216" class="journal has-notes">
    <h4><a href="46636.html#note-2" class="journal-link">#2</a>
    
    <a name="note-2"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/37356">Marco Falkenberg</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-25" title="2013-04-25 10:36">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161216-notes"><p>A solution would be to write a new slot which unsets the locked roles and connect it with the authenticatedToken signal of the AuthenticationProviderManager.</p></div>
  </div>
  

  <div id="change-161763" class="journal has-notes has-details">
    <h4><a href="46636.html#note-3" class="journal-link">#3</a>
    
    <a name="note-3"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-29" title="2013-04-29 18:59">over 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Subject</strong> changed from <i>Broken Authentication via HTTP-Basic</i> to <i>Authentication does not work any longer without redirects</i></li>
      
       <li><strong>Priority</strong> changed from <i>Should have</i> to <i>Must have</i></li>
      
       <li><strong>Target version</strong> set to <i>2.0</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-161763-notes"><p>Marco, this one cost me some hours too..<br />The issue is not only true for HTTP authentication but for most authentication providers! Usually the issue doesn't matter though, because of a redirection to some other action.</p>


	<p>The problem is that the <strong>PersistenceQueryRewritingAspect</strong> calls <strong>SecurityContext::getRoles()</strong> for all <strong>Query::execute()</strong> invokations. That means that the following code<br /><pre>
<code class="php syntaxhl"><span class="CodeRay"><span class="line-numbers">1</span><span class="local-variable">$account</span> = <span class="local-variable">$this</span>-&gt;accountRepository-&gt;findActiveByAccountIdentifierAndAuthenticationProviderName(<span class="local-variable">$credentials</span>[<span class="string"><span class="delimiter">'</span><span class="content">username</span><span class="delimiter">'</span></span>], <span class="local-variable">$this</span>-&gt;name);
</span></code><br /></pre></p>


	<p>in <strong>PersistedUsernamePasswordProvider</strong> implicitly initializes the security context with the roles <strong>Everybody</strong> &#38; <strong>Anonymous</strong></p></div>
  </div>
  

  <div id="change-161892" class="journal has-details">
    <h4><a href="46636.html#note-4" class="journal-link">#4</a>
    
    <a name="note-4"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 08:47">over 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>New</i> to <i>Accepted</i></li>
      
       <li><strong>Assigned To</strong> set to <i>Bastian Waidelich</i></li>
      
    </ul>
    
    
  </div>
  

  <div id="change-161901" class="journal has-notes has-details">
    <h4><a href="46636.html#note-5" class="journal-link">#5</a>
    
    <a name="note-5"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 09:42">over 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>Accepted</i> to <i>Under Review</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-161901-notes"><p>Patch set 1 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-161904" class="journal has-notes">
    <h4><a href="46636.html#note-6" class="journal-link">#6</a>
    
    <a name="note-6"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/316">Christopher Hlubek</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 10:02">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161904-notes"><p>What about using some context to disable the <code>PersistenceQueryRewritingAspect</code> in the AccountRepository? This is a feature we would also need for policy enforcement. This would allow to execute queries (or call methods) without security in an explicit way. This is also useful for example in commands where usually no account is authenticated or in low-level tasks.</p>


	<p>Pseudocode:</p>


<pre><code>
$this-&gt;securityContext-&gt;withoutAuthorization(function() use ($accountRepository, $credentials, &#38;$account) {
    $account = $accountRepository-&gt;findActiveByAccountIdentifierAndAuthenticationProviderName($credentials['username'], $this-&gt;name);
});
</code></pre>

	<p>The aspect could check for a global flag in <code>Security\Context</code> and have an early return.</p>


	<p>Bastian Waidelich wrote:</p>


<blockquote>

	<p>The problem is that the <strong>PersistenceQueryRewritingAspect</strong> calls <strong>SecurityContext::getRoles()</strong> for all <strong>Query::execute()</strong> invokations.</p>


</blockquote></div>
  </div>
  

  <div id="change-161906" class="journal has-notes">
    <h4><a href="46636.html#note-7" class="journal-link">#7</a>
    
    <a name="note-7"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/10">Karsten Dambekalns</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 10:18">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161906-notes"><p>IIRC we ignored security in the aspect if the SecurityContext cannot be initialized - that used to work fine in the past. Hm.</p></div>
  </div>
  

  <div id="change-161909" class="journal has-notes">
    <h4><a href="46636.html#note-8" class="journal-link">#8</a>
    
    <a name="note-8"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 10:57">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161909-notes"><p>Karsten Dambekalns wrote:</p>


<blockquote>

	<p>IIRC we ignored security in the aspect if the SecurityContext cannot be initialized - that used to work fine in the past. Hm.</p>


</blockquote>

	<p>There's even a test <strong>rewriteQomQueryDoesNotRewriteQueryIfSecurityContextCannotBeInitialized</strong> in <strong>PersistenceQueryRewritingAspectTest</strong> ;)</p></div>
  </div>
  

  <div id="change-161910" class="journal has-notes">
    <h4><a href="46636.html#note-9" class="journal-link">#9</a>
    
    <a name="note-9"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 11:00">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161910-notes"><p>Bastian Waidelich wrote:</p>


<blockquote>

	<p>Karsten Dambekalns wrote:</p>


<blockquote>

	<p>IIRC we ignored security in the aspect if the SecurityContext cannot be initialized - that used to work fine in the past. Hm.</p>


</blockquote></blockquote>

	<p>..But this has been changed with the aim to "enforce Query Rewriting more reliably": <a class="external" href="../../external.html?link=https://review.typo3.org/#/c/16106/">https://review.typo3.org/#/c/16106/</a></p>


	<p>So maybe Christophers suggestion would be the way to go</p></div>
  </div>
  

  <div id="change-161912" class="journal has-notes">
    <h4><a href="46636.html#note-10" class="journal-link">#10</a>
    
    <a name="note-10"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 11:18">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161912-notes"><p>Bastian Waidelich wrote:</p>


<blockquote>

	<p>So maybe Christophers suggestion would be the way to go</p>


</blockquote>

	<p>I just gave this a quick try and it seems to work fine! I'll push a WIP</p></div>
  </div>
  

  <div id="change-161970" class="journal has-notes">
    <h4><a href="46636.html#note-11" class="journal-link">#11</a>
    
    <a name="note-11"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-04-30" title="2013-04-30 16:38">over 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-161970-notes"><p>Patch set 2 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-163669" class="journal has-notes">
    <h4><a href="46636.html#note-12" class="journal-link">#12</a>
    
    <a name="note-12"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 12:30">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-163669-notes"><p>Patch set 3 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-163677" class="journal has-notes">
    <h4><a href="46636.html#note-13" class="journal-link">#13</a>
    
    <a name="note-13"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 14:08">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-163677-notes"><p>Patch set 4 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-163754" class="journal has-notes">
    <h4><a href="46636.html#note-14" class="journal-link">#14</a>
    
    <a name="note-14"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 16:52">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-163754-notes"><p>Patch set 5 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-163770" class="journal has-notes">
    <h4><a href="46636.html#note-15" class="journal-link">#15</a>
    
    <a name="note-15"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 17:42">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-163770-notes"><p>Patch set 6 for branch <strong>master</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20346">https://review.typo3.org/20346</a></p></div>
  </div>
  

  <div id="change-163772" class="journal has-notes">
    <h4><a href="46636.html#note-16" class="journal-link">#16</a>
    
    <a name="note-16"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/36798">Gerrit Code Review</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 17:48">about 2 years</a> ago</h4>

    
    <div class="wiki" id="journal-163772-notes"><p>Patch set 1 for branch <strong>2.0</strong> has been pushed to the review server.<br />It is available at <a class="external" href="../../external.html?link=https://review.typo3.org/20586">https://review.typo3.org/20586</a></p></div>
  </div>
  

  <div id="change-163793" class="journal has-notes has-details">
    <h4><a href="46636.html#note-17" class="journal-link">#17</a>
    
    <a name="note-17"></a>
    Updated by <a href="../../external.html?link=https://forge.typo3.org/users/61">Bastian Waidelich</a> <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/activity?from=2013-05-07" title="2013-05-07 18:35">about 2 years</a> ago</h4>

    
    <ul class="details">
      
       <li><strong>Status</strong> changed from <i>Under Review</i> to <i>Resolved</i></li>
      
       <li><strong>% Done</strong> changed from <i>0</i> to <i>100</i></li>
      
    </ul>
    
    <div class="wiki" id="journal-163793-notes"><p>Applied in changeset <a href="../../external.html?link=https://forge.typo3.org/projects/package-typo3-flow/repository/revisions/e06e0f2dd6eb565f00ae535c780ab13b74de8f92" class="changeset" title="[BUGFIX] Authentication does not work any longer without redirects This fixes a regression that ...">e06e0f2dd6eb565f00ae535c780ab13b74de8f92</a>.</p></div>
  </div>
  




</div>



<div style="clear: both;"></div>
<div class="contextual">


<span class="issue-46636-watcher"></span>


</div>


<div style="clear: both;"></div>


<p class="other-formats">Also available in:
  <span><a href="../../external.html?link=https://forge.typo3.org/issues/46636.atom" class="atom" rel="nofollow">Atom</a></span>
  <span><a href="46636.pdf" class="pdf" rel="nofollow">PDF</a></span>
</p>







<script type="text/javascript">
//<![CDATA[
new ContextMenu('/issues/context_menu')
//]]>
</script>

        
				<div style="clear:both;"></div>
    </div>
</div>

<div id="ajax-indicator" style="display:none;"><span>Loading...</span></div>
<div id="ajax-modal" style="display:none;"></div>
	
<div id="footer">
 Powered by <a href="../../external.html?link=http://www.redmine.org/">Redmine</a> &copy; 2006-2012 Jean-Philippe Lang<br /><br />
 Hosting sponsor:<br /><br />
 <script type="text/javascript">var buttonStyle = "footer-grey-31";</script>
 <script src="../../typo3.org/fileadmin/t3org/images/FM-content/team-pages/server-team/sponsor-banners/sponsors.js"></script>
</div>
</div>

<script type="text/javascript">
    var pkBaseURL = (("https:" == document.location.protocol) ? "https://piwik.typo3.org/" : "http://piwik.typo3.org/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
    try {
        var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 14);
        piwikTracker.trackPageView();
        piwikTracker.enableLinkTracking();
    } catch( err ) {}
</script>
<noscript><span style="visibility: hidden";><img src="../../external.html?link=http://piwik.typo3.org/piwik.php?idsite=14" style="border:0" alt=""/></span></noscript>
</body>

<!-- Mirrored from forge.typo3.org/issues/46636 by HTTrack Website Copier/3.x [XR&CO'2008], Mon, 03 Aug 2015 22:08:17 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
</html>
